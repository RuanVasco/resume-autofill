<div class="popup-container">
  <div class="header">
    <mat-icon class="header-icon">auto_fix_high</mat-icon>
    <h1>Resume AutoFill</h1>
  </div>

  <input
    #fileInput
    type="file"
    (change)="onFileSelected($event)"
    accept=".pdf"
    hidden
  />

  <!-- Estado: Carregando -->
  @if (isLoading()) {
    <div class="loading-state">
      <mat-progress-bar mode="indeterminate" />
      <p class="loading-text">Processando currículo...</p>
    </div>
  }

  <!-- Estado: Com currículo salvo -->
  @if (hasResume() && !isLoading()) {
    <mat-card appearance="outlined" class="resume-card">
      <mat-card-content>
        <div class="resume-header">
          <mat-icon class="pdf-icon">picture_as_pdf</mat-icon>
          <div class="resume-info">
            <span class="resume-filename">{{ fileName() }}</span>
            <span class="resume-label">Currículo salvo</span>
          </div>
        </div>

        @if (resumeContent()) {
          <div class="resume-preview">
            <small class="preview-label">Preview do conteúdo:</small>
            <p class="preview-text">{{ resumeContent()!.substring(0, 200) }}...</p>
          </div>
        }
      </mat-card-content>

      <mat-card-actions>
        <button mat-button (click)="fileInput.click()">
          <mat-icon>swap_horiz</mat-icon>
          Trocar PDF
        </button>
        <button mat-button color="warn" (click)="removeResume()">
          <mat-icon>delete_outline</mat-icon>
          Remover
        </button>
      </mat-card-actions>
    </mat-card>
  }

  <!-- Estado: Sem currículo -->
  @if (!hasResume() && !isLoading()) {
    <div class="upload-zone" (click)="fileInput.click()">
      <mat-icon class="upload-icon">cloud_upload</mat-icon>
      <p class="upload-title">Envie seu currículo</p>
      <p class="upload-hint">Clique para selecionar um arquivo PDF</p>
      <button mat-flat-button>
        <mat-icon>upload_file</mat-icon>
        Selecionar PDF
      </button>
    </div>
  }

  <mat-divider />

  <!-- Seção: API Key -->
  <mat-card appearance="outlined" class="apikey-card">
    <mat-card-content>
      <div class="apikey-header">
        <mat-icon class="key-icon">vpn_key</mat-icon>
        <div class="apikey-info">
          <span class="apikey-title">API Key do Gemini</span>
          @if (hasApiKey() && !isEditingApiKey()) {
            <span class="apikey-value">{{ apiKeyMasked() }}</span>
          } @else if (!hasApiKey() && !isEditingApiKey()) {
            <span class="apikey-empty">Nenhuma API key configurada</span>
          }
        </div>
      </div>

      @if (hasApiKey() && !isEditingApiKey()) {
        <div class="model-selector">
          <mat-form-field appearance="outline" class="model-field">
            <mat-label>Modelo</mat-label>
            @if (isLoadingModels()) {
              <mat-select disabled>
                <mat-option>Carregando...</mat-option>
              </mat-select>
            } @else {
              <mat-select
                [value]="selectedModelId()"
                (selectionChange)="onModelSelected($event.value)"
              >
                @for (model of models(); track model.id) {
                  <mat-option [value]="model.id">{{ model.displayName }}</mat-option>
                }
                @if (models().length === 0) {
                  <mat-option [value]="selectedModelId()">{{ selectedModelId() }}</mat-option>
                }
              </mat-select>
            }
            <mat-icon matPrefix>smart_toy</mat-icon>
          </mat-form-field>
          @if (modelsError()) {
            <span class="models-error">{{ modelsError() }}</span>
          }
        </div>
      }

      @if (!hasApiKey() || isEditingApiKey()) {
        <div class="apikey-form">
          <mat-form-field appearance="outline" class="apikey-field">
            <mat-label>API Key</mat-label>
            <input
              matInput
              type="password"
              placeholder="Cole sua API key aqui"
              [ngModel]="apiKeyInput()"
              (ngModelChange)="apiKeyInput.set($event)"
              (keyup.enter)="saveApiKey()"
            />
            <mat-icon matPrefix>key</mat-icon>
          </mat-form-field>
        </div>
      }
    </mat-card-content>

    <mat-card-actions>
      @if (!hasApiKey() && !isEditingApiKey()) {
        <button mat-flat-button (click)="saveApiKey()">
          <mat-icon>save</mat-icon>
          Salvar
        </button>
      } @else if (hasApiKey() && !isEditingApiKey()) {
        <button mat-button (click)="startEditApiKey()">
          <mat-icon>edit</mat-icon>
          Editar
        </button>
        <button mat-button color="warn" (click)="removeApiKey()">
          <mat-icon>delete_outline</mat-icon>
          Remover
        </button>
      } @else if (isEditingApiKey()) {
        <button mat-flat-button (click)="saveApiKey()">
          <mat-icon>save</mat-icon>
          Salvar
        </button>
        <button mat-button (click)="cancelEditApiKey()">
          <mat-icon>close</mat-icon>
          Cancelar
        </button>
      }
    </mat-card-actions>
  </mat-card>

  <mat-divider />

  <!-- Seção: Autofill -->
  <div class="autofill-section">
    @if (isAutoFilling()) {
      <mat-progress-bar mode="indeterminate" />
      <p class="autofill-status-text">Analisando formulário e preenchendo campos...</p>
    }

    @if (!hasResume() && !hasApiKey()) {
      <p class="autofill-hint">
        <mat-icon class="hint-icon">info</mat-icon>
        Envie seu currículo e configure a API key para começar.
      </p>
    } @else if (!hasResume()) {
      <p class="autofill-hint">
        <mat-icon class="hint-icon">info</mat-icon>
        Envie seu currículo para habilitar o preenchimento automático.
      </p>
    } @else if (!hasApiKey()) {
      <p class="autofill-hint">
        <mat-icon class="hint-icon">info</mat-icon>
        Configure a API key do Gemini para habilitar o preenchimento.
      </p>
    }

    <button
      mat-fab
      extended
      (click)="startAutoFill()"
      [disabled]="!canAutoFill()"
      class="autofill-button"
    >
      <mat-icon>auto_fix_high</mat-icon>
      Preencher formulário
    </button>
  </div>
</div>
